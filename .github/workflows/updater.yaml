name: "Flake updater"

on:
  # schedule:
  #   - cron: "0 0 * * *"
  pull_request:
  push:

jobs:
  update_linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GH_PAT }}
          github-token: ${{ secrets.GH_PAT }}
      - name: Add & update nixpkgs channel
        run: |
          nix-channel --add https://nixos.org/channels/nixos-24.05 nixpkgs
          nix-channel --update nixpkgs

          nix profile install nixpkgs#nixos-rebuild nixpkgs#nvd

      - name: Building NixOS baseline...
        run: |
          set -xe
          MACHINE_KEY="appaquet@deskapp" ./x nixos build
          mv result nixos-result-before

      - name: Building Home Manager baseline...
        run: |
          set -xe
          MACHINE_KEY="appaquet@deskapp" ./x home build
          mv result home-result-before

      - name: Update flakes
        run: |
          set -xe
          nix flake update

      - name: Building NixOS new
        run: |
          set -xe
          MACHINE_KEY="appaquet@deskapp" ./x nixos build
          mv result nixos-result-after

      - name: Building Home Manager new
        run: |
          set -xe
          MACHINE_KEY="appaquet@deskapp" ./x home build
          mv result home-result-after

      - name: Diffing...
        run: |
          set -xe
          nvd diff nixos-result-before nixos-result-after
          nvd diff home-result-before home-result-after

  update_darwin:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GH_PAT }}
          github-token: ${{ secrets.GH_PAT }}
      - name: Add & update nixpkgs channel
        run: |
          nix-channel --add https://nixos.org/channels/nixos-24.05 nixpkgs
          nix-channel --update nixpkgs

          nix profile install nixpkgs#nvd

      - name: Building baseline...
        run: |
          set -xe
          MACHINE_KEY="appaquet@mbpapp" ./x darwin build
          mv result darwin-result-before

      - name: Update flakes
        run: |
          set -xe
          nix flake update

      - name: Building new...
        run: |
          set -xe
          MACHINE_KEY="appaquet@mbpapp" ./x darwin build
          mv result darwin-result-after

      - name: Diffing...
        run: |
          set -xe
          nvd diff ./darwin-result-before ./darwin-result-after
